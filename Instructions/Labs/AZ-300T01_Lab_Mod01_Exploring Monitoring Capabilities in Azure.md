---
lab:
    title: 'Azure의 모니터링 기능 살펴보기'
    module: '모듈 1: Azure 구독 및 리소스 관리'
---

# Azure 구독 및 리소스 관리

# 랩: Azure의 모니터링 기능 살펴보기

### 시나리오

Adatum Corporation에서 Azure의 모니터링 기능을 살펴보려고 합니다.

### 목표

이 랩을 완료하면 다음 작업을 수행할 수 있습니다.

- Azure VM Scale Sets 배포

- Azure Monitor를 사용하여 모니터링 및 경고 구현

### 랩 설정

예상 소요 시간: 45분

사용자 이름: **Student**

암호: **Pa55w.rd**

# 연습 1: Azure VM Scale Sets 배포

이 연습의 주요 태스크는 다음과 같습니다.

1. Azure 빠른 시작 템플릿을 사용하여 Azure VM Scale Sets 배포

1. Azure VM 확장 집합의 자동 크기 조정 설정 검토

#### 태스크 1: Azure 빠른 시작 템플릿을 사용하여 Azure VM Scale Sets 배포

1. 랩 가상 머신에서 Microsoft Edge를 시작하여 Azure Portal(http://portal.azure.com)로 이동한 다음 대상 Azure 구독에서 소유자 역할이 지정된 Microsoft 계정을 사용하여 로그인합니다.

1. Microsoft Edge 창에 표시된 Azure Portal을 통해 Cloud Shell 내에서 **PowerShell** 세션을 시작합니다.

1. **탑재된 스토리지가 없음** 메시지가 표시되면 **고급 설정 표시** 를 클릭하고 다음 설정을 사용하여 스토리지를 구성합니다.

   - 구독: 대상 Azure 구독의 이름

   - Cloud Shell 지역: 구독에서 사용할 수 있으며 랩 위치에 가장 가까운 Azure 지역의 이름

   - 리소스 그룹: 새 리소스 그룹 **az3000100-LabRG** 의 이름

   - 스토리지 계정: 새 스토리지 계정의 이름(소문자/숫자를 사용하여 3~24자로 입력)

   - 파일 공유: 새 파일 공유의 이름: **cloudshell**

1. Cloud Shell 창에서 다음 명령을 실행하여 고유한 DNS 도메인 이름을 확인합니다. 여기서 자리 표시자 `<custom-label>`은 문자로 시작하는 9자 이내의 영숫자 문자열(고유한 문자열일 가능성이 높음)로 대체합니다. 그리고 자리 표시자 `<location>`은 이 랩에서 리소스를 배포할 Azure 지역 이름으로 대체합니다.

```pwsh
   Test-AzDnsAvailability -DomainNameLabel <custom-label> -Location '<location>'
```

1. 이 명령이 **True** 를 반환하는지 확인합니다. True가 반환되지 않으면 **True** 가 반환될 때까지 `<custom-label>`의 다른 값을 사용해 같은 명령을 다시 실행합니다.

1. True가 반환된 `<custom-label>`의 값을 확인합니다. 다음 태스크에서 해당 값을 사용해야 합니다.

1. 랩 가상 머신에서 Microsoft Edge를 시작하여 Ubuntu 16.04에서 자동 크기 조정 데모 앱을 배포하는 Azure 빠른 시작 템플릿([**https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale**](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale))으로 이동합니다.

1. **Azure에 배포** 를 클릭한 다음 메시지가 표시되면 대상 Azure 구독에서 소유자 역할이 지정된 Microsoft 계정을 사용하여 로그인합니다.

1. Azure Portal의 **Python Bottle 서버를 사용하여 VM 확장 집합 배포 및 자동 크기 조정** 블레이드에서 다음 설정을 지정하고 배포를 시작합니다.

   - 구독: 대상 Azure 구독의 이름

   - 리소스 그룹: 새 리소스 그룹 **az3000101-LabRG** 의 이름

   - 위치: 이 태스크의 이전 단계에서 `Test-AzDnsAvailability`를 실행할 때 참조했던 Azure 지역의 이름

   - Vm Sku: **Standard_D1_v2**

   - Vmss 이름: 이 태스크의 이전 단계에서 `Test-AzDnsAvailability`를 실행할 때 확인된 사용자 지정 레이블

   - 인스턴스 수: **1**

   - 관리 사용자 이름: **student**

   - 관리자 암호: **Pa55w.rd1234**

1. **위에 명시된 사용 약관에 동의함** 옆의 확인란을 선택하고 **구매** 를 클릭합니다.

1. 배포가 완료될 때까지 기다립니다. 배포가 완료되려면 5분 정도 걸립니다.

#### 태스크 2: Azure VM 확장 집합의 자동 크기 조정 설정 검토

1. Azure Portal에서 새로 배포된 **Azure VM 확장 집합** 을 나타내는 블레이드로 이동합니다.

1. VM 확장 집합 블레이드에서 **크기 조정** 블레이드로 이동합니다.

1. Azure VM 확장 집합은 다음 기준을 사용하여 메트릭에 따라 동적으로 크기가 조정되도록 구성됩니다.

   - 규모 확장: CPU의 평균 백분율이 60보다 크면 인스턴스 수를 1개씩 늘림

   - 규모 감축: CPU의 평균 백분율이 30보다 작으면 인스턴스 수를 1개씩 줄임

   - 최소 인스턴스 수: 1

   - 최대 인스턴스 수: 10

1. 최대 인스턴스 수를 3개로 수정하고 변경 내용을 **저장** 합니다.

> **결과**: Azure VM 확장 집합을 배포하고 크기 조정 설정을 검토하여 이 연습을 완료해야 합니다.

## 연습 2: Azure Monitor를 사용하여 모니터링 및 경고 구현

이 연습의 주요 태스크는 다음과 같습니다.

1. Azure VM 확장 집합 메트릭 기반 경고 만들기

1. Azure VM 확장 집합 자동 크기 조정 기반 알림 구성

1. Azure VM 확장 집합 모니터링 및 경고 테스트

#### 태스크 1: Azure VM 확장 집합 메트릭 기반 경고 만들기

1. Azure Portal에서 새로 배포된 Azure VM 확장 집합을 나타내는 블레이드로 이동한 다음 해당 블레이드에서 **모니터링 - 메트릭** 블레이드로 전환합니다.

1. **모니터링 - 메트릭** 블레이드에서 필터를 사용하여 이 랩의 이전 연습에서 프로비전한 VM 확장 집합 리소스의 **평균** 집계 값이 포함된 **CPU 백분율** 메트릭을 표시합니다.

1. 결과 차트를 검토하여 지난 몇 분 동안의 평균 CPU 백분율을 확인합니다.

1. **모니터링** 에서 **경고** 블레이드로 이동합니다.

1. **경고** 블레이드에서 **작업 관리** 블레이드로 이동합니다.

1. **작업 관리** 섹션에서 **작업 그룹 추가** 를 클릭하고 작업 그룹 이름을 **az30001 action group** 으로, 짧은 이름을 **az30001** 로 설정한 다음 이전 연습에서 사용한 Azure 구독을 선택하고 리소스의 기본 이름인 **Default-ActivityLogAlerts (to be created)** 를 그대로 적용합니다. 그런 후에 작업 이름을 **az30001-email** 로, 작업 유형을 **이메일/SMS/푸시/음성** 으로 설정합니다. 

1. **이메일/SMS/푸시/음성** 블레이드에서 이 규칙에 의해 생성된 경고를 수신하는 데 사용할 이메일 주소, 휴대폰 번호 또는 전화 번호를 설정합니다.

1. 작업 그룹 추가 페이지에서 **확인** 을 클릭합니다.

1. **경고** 블레이드로 이동합니다.

1. **경고** 블레이드에서 **새 경고 규칙** 블레이드로 이동합니다.
1. **리소스** 섹션에서 이 랩의 이전 연습에서 프로비전한 VM 확장 집합을 선택합니다.

1. **조건** 섹션에서 **조건 추가** 를 클릭하고 **CPU 백분율** 메트릭을 선택한 다음 크기 설정 및 조건 유형은 기본값으로 유지합니다. 그런 다음 조건을 **보다 큼** 으로, 시간 집계를 **평균** 으로, 임계값을 **60** 으로, 집계 세분성(기간)을 **1분** 으로, 빈도를 **1분마다** 로 설정한 후에 **완료** 를 클릭합니다.

1. **작업** 섹션에서 **작업 그룹 선택**을 클릭하고 이전에 만든 **az30001 action group** 작업 그룹을 선택한 다음 **완료**를 클릭합니다.

1. **경고 세부 정보** 섹션에서 경고 규칙 이름을 **VM 확장 집합의 CPU 백분율이 60%보다 큼** 으로, 규칙 설명을 **VM 확장 집합의 CPU 백분율이 60%보다 큼** 으로, 심각도를 **심각도 3** 으로, 규칙을 만들면 바로 사용을 **예** 로 설정합니다.

1. **경고 규칙 만들기** 를 클릭합니다.

   > **참고**: 메트릭 경고 규칙이 활성화되려면 최대 10분이 걸릴 수 있습니다. 

#### 태스크 2: Azure VM 확장 집합 자동 크기 조정 기반 알림 구성

1. Azure Portal에서 새로 배포된 Azure VM 확장 집합을 나타내는 블레이드로 이동한 다음 해당 블레이드에서 **크기 조정** 블레이드로 전환합니다.

1. **크기 조정** 블레이드에서 **알림** 탭 제목을 클릭하고 다음 설정을 구성한 후에 변경 내용을 **저장** 합니다.

   - 이메일 관리자: 사용

   - 이메일 공동 관리자: 사용 안 함

   - 추가 관리자 이메일: 이벤트 자동 크기 조정 관련 알림을 수신하는 데 사용할 이메일 주소 추가

#### 태스크 3: Azure VM 확장 집합 모니터링 및 경고 테스트

1. Azure Portal에서 **부하 분산 장치** 를 검색한 다음 부하 분산 장치 블레이드로 이동합니다. 이 블레이드에 부하 분산 장치(이 랩의 이전 연습에서 템플릿을 통해 배포한 확장 집합으로 만든 부하 분산 장치)가 표시되어야 합니다.

1. VM 확장 집합과 연결되어 있는 부하 분산 장치의 프런트 엔드에 할당된 **공용 IP 주소** 의 값을 확인합니다.

1. 랩 컴퓨터에서 Microsoft Edge를 시작하고 **http://*공용 IP 주소\*:9000** 으로 이동합니다. 여기서 **_공용 IP 주소_** 는 이전 단계에서 확인한 IP 주소입니다.

1. **작업자 인터페이스** 페이지에서 **작업 시작** 링크를 클릭합니다.

1. VM 확장 집합 개요 블레이드의 **CPU(평균)** 차트를 사용하여 CPU 사용률 변경 내용을 모니터링합니다.

   > **참고**: **메트릭** 블레이드로 다시 이동한 다음 필터를 사용하여 VM 확장 집합 리소스의 **CPU 백분율** 메트릭을 표시하고 시간을 **지난 30분** 으로 설정할 수도 있습니다.

   > **참고**: 몇 분 내에 CPU 사용률 증가 관련 경고가 표시됩니다.

1. VM 확장 집합의 **인스턴스** 블레이드로 전환하여 인스턴스 수를 확인합니다.

   > **참고**: **크기 조정** 블레이드로 다시 이동한 다음 자동 크기 조정이 가능한 리소스 목록에서 VM 확장 집합의 이름을 클릭하고, **자동 크기 조정 설정** 블레이드에서 **실행 기록** 을 클릭한 후에 자동 크기 조정 이벤트 목록을 검토할 수도 있습니다.

   > **참고**: 몇 분 내에 자동 크기 조정이 트리거됩니다.

1. 작업자 인스턴스 페이지가 표시된 Microsoft Edge 창으로 전환한 다음 **작업 중지** 링크를 클릭합니다.

1. VM 확장 집합의 규모를 확장할 때 사용한 것과 같은 방법을 사용하여 이벤트에서 크기 조정 및 CPU 사용률 감소를 모니터링합니다.

> **결과**: Azure Monitor를 사용해 모니터링과 경고를 구현 및 테스트하여 이 연습을 완료해야 합니다.

## 연습 3: 랩 리소스 제거

### 태스크 1: 리소스 그룹 삭제

1. panel 포털 상단에서 **Cloud Shell** 아이콘을 클릭하여 Clould Shell 창을 열고 필요한 경우 Bash 셸로 전환합니다.

1. **Cloud Shell** 명령 프롬프트에 다음 명령을 입력하고 **Enter** 키를 눌러 이 랩에서 만든 모든 리소스 그룹의 목록을 표시합니다.

```
   az group list --query "[?starts_with(name,'az300010')].[name]" --output tsv
```

1. 이 랩에서 만든 리소스 그룹만 출력에 포함되어 있는지 확인합니다. 다음 태스크에서 이러한 그룹을 삭제합니다.

#### 태스크 2: 리소스 그룹 삭제

1. **Cloud Shell** 명령 프롬프트에 다음 명령을 입력하고 **Enter** 키를 눌러 이 랩에서 만든 리소스 그룹을 삭제합니다.

```
   az group list --query "[?starts_with(name,'az300010')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. Portal 하단의 **Cloud Shell** 프롬프트를 닫습니다.

> **결과**: 이 랩에서 사용한 모든 리소스를 제거하여 이 연습을 완료해야 합니다.
